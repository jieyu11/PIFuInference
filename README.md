# PIFu and PIFuHD Algorithms Tests

The PIFu ([here](https://github.com/shunsukesaito/PIFu)) and PIFuHD ([here](https://github.com/facebookresearch/pifuhd)) having been making promissing
improvments towards 3D human reconstruction by the application of `Pixel-Aligned Implicit Function`.

The following steps help us test the two algorithms with personal images.

## Build Docker Image
Building the docker image with the dockerfile in the current folder.
```
docker build -t pifu .
```

## Prepare Input Images
Copy the input images into the current folder, e.g.
```
$PWD/images/source/EricFootball_crop
```

### Prepare Semantic Segmentation of Human in the Images
The `PIFu` networks requires the segmenation of the human represented with
color white (color=`[255, 255, 255]`) and background in black (color=`[0,0,0]`).
We can run the `selftrain` (or any other `bgseg` algorithms in our existing modules) to obtain the mask images. 

A script to do so is prepared:
```
# be sure to first modify the parameters like the input images folder
# selftrain docker image tag, etc in the source file.
source run_standalone_imagefolder_selftrain.sh
```

## Launch Docker Images
```
images=$PWD/images/source/EricFootball_crop
masks=$PWD/images/mask/EricFootball_crop
output=$PWD/outputs
mkdir -p $output
docker run -it --rm --gpus all \
	-v $images:/data/images \
	-v $masks:/data/masks \
	-v $output:/output \
	pifu
```

## PIFu: Testing

### PIFu: Copy Images To the Correct Folder with Correct Names
The images files on the launched docker container should be saved in
`$WORK_ROOT/pifu/sample_images`.
The name of the mask file should be the same name with postfix `_mask`. For 
example an image is located: `sample_images/abc.jpg`, then the mask file
is required to be named: `sample_images/abc_mask.png`. The image extension is
irrelevant.

If needed, following shell script help to copy the images to their corresponding
locations.

```
#!/bin/bash

for name in `ls /data/images/`; do 
	cp /data/images/$name sample_images/$name; 
	cp /data/masks/labels_$name sample_images/${name::-4}_mask.png;
done
```

### PIFu: Run Demo Tests
Once docker container is launched and images are prepared. Simply do:
```
cd PIFu
./scripts/test.sh
```
inside the docker container, which will produce results under: `PIFu/results`


## PIFuHD: Testing

### PIFuHD: Rectangle Generation
PIFuHD doesn't require segmenation masks, but it needs either image segmentation
in `json` format (like CoCo dataset) or a rectangle definition in `txt` file.
For simplicity, the rectangle file can be generated with 
`pifuhd/scripts/pifuhd_get_rect.py`.

To do so one needs to launch one docker container and run the script:

```
cd pifuhd/lightweight-human-pose-estimation.pytorch/
python pifuhd_get_rect.py -i /path/dir/of/input/images/ \
   -o /path/dir/of/output/rect/txt/
```

### PIFuHD: Model Inference
Once the rectangle files are generated by the code in the section above, one can
now make the model inference with each image.

```
images=/path/dir/of/input/images/
rectdir=/path/dir/of/input/rect/
output=/path/dir/for/outputs/
mkdir -p $output
docker run -it --rm --gpus all \
	-v $images:/data/images \
	-v $rectdir:/data/rect \
	-v $output:/output \
	pifu \
	/bin/bash -c "cd pifuhd; mkdir -p samples; \
	cp /data/images/* /data/rect/* samples; \
	python -m apps.simple_test -r 512 --use_rect -i samples -o /output;
```
